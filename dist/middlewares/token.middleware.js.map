{"version":3,"sources":["../../src/middlewares/token.middleware.ts"],"sourcesContent":["import { verify } from \"jsonwebtoken\";\nimport { NextFunction, Request, Response } from \"express\";\nimport { HttpException } from \"@/exceptions/HttpException\";\nimport { DataStoredInToken } from \"@/interfaces/auth.interface\";\nimport { PrismaClient } from \"@prisma/client\";\n\n\nfunction getTimeStampFromHeader(req: Request) {\n    const timestamp = Date.parse(req.header('X-TXC-TIMESTAMP'));\n    if (!timestamp) {\n        throw new HttpException(400, 'Timestamp header is missing')\n    }\n    return timestamp\n\n}\n\n\n\nexport const TokenSessionMiddleWare = async (req: Request, res: Response, next: NextFunction) => {\n    const session = new PrismaClient().session\n    const token = req.header('Access-Token').split(' ')[1];\n    if (!token) next(new HttpException(401, 'Access Token is missing'));\n    try {\n        const timestamp = getTimeStampFromHeader(req);\n        if(!timestamp) next(new HttpException(400, 'Timestamp header is missing'))\n        const secretKey: string = process.env.SECRET_KEY;\n        const verificationResponse = verify(token, secretKey) as DataStoredInToken;\n        const foundSession = await session.findUnique({\n            where: {\n                id: verificationResponse.id\n            }\n        })\n        if(!foundSession) next(new HttpException(404, 'Session not found-- Unauthorized'))\n        if(timestamp > foundSession.createdAt.getTime()/10000 + 300) next(new HttpException(401, 'Session Expired'))\n        next()\n    } catch (error) {\n        next(error)\n    }\n}"],"names":["TokenSessionMiddleWare","getTimeStampFromHeader","req","timestamp","Date","parse","header","HttpException","res","next","session","PrismaClient","token","split","secretKey","process","env","SECRET_KEY","verificationResponse","verify","foundSession","findUnique","where","id","createdAt","getTime","error"],"rangeMappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;","mappings":";;;;+BAkBaA;;;eAAAA;;;8BAlBU;+BAEO;wBAED;AAG7B,SAASC,uBAAuBC,GAAY;IACxC,MAAMC,YAAYC,KAAKC,KAAK,CAACH,IAAII,MAAM,CAAC;IACxC,IAAI,CAACH,WAAW;QACZ,MAAM,IAAII,4BAAa,CAAC,KAAK;IACjC;IACA,OAAOJ;AAEX;AAIO,MAAMH,yBAAyB,OAAOE,KAAcM,KAAeC;IACtE,MAAMC,UAAU,IAAIC,oBAAY,GAAGD,OAAO;IAC1C,MAAME,QAAQV,IAAII,MAAM,CAAC,gBAAgBO,KAAK,CAAC,IAAI,CAAC,EAAE;IACtD,IAAI,CAACD,OAAOH,KAAK,IAAIF,4BAAa,CAAC,KAAK;IACxC,IAAI;QACA,MAAMJ,YAAYF,uBAAuBC;QACzC,IAAG,CAACC,WAAWM,KAAK,IAAIF,4BAAa,CAAC,KAAK;QAC3C,MAAMO,YAAoBC,QAAQC,GAAG,CAACC,UAAU;QAChD,MAAMC,uBAAuBC,IAAAA,oBAAM,EAACP,OAAOE;QAC3C,MAAMM,eAAe,MAAMV,QAAQW,UAAU,CAAC;YAC1CC,OAAO;gBACHC,IAAIL,qBAAqBK,EAAE;YAC/B;QACJ;QACA,IAAG,CAACH,cAAcX,KAAK,IAAIF,4BAAa,CAAC,KAAK;QAC9C,IAAGJ,YAAYiB,aAAaI,SAAS,CAACC,OAAO,KAAG,QAAQ,KAAKhB,KAAK,IAAIF,4BAAa,CAAC,KAAK;QACzFE;IACJ,EAAE,OAAOiB,OAAO;QACZjB,KAAKiB;IACT;AACJ"}